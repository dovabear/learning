-- A: Create a master key.
-- Only necessary if one does not already exist.
-- Required to encrypt the credential secret in the next step.

CREATE MASTER KEY;


-- B: Create a database scoped credential
-- IDENTITY: Provide any string, it is not used for authentication to Azure storage.
-- SECRET: Provide your Azure storage account key.


CREATE DATABASE SCOPED CREDENTIAL BlobStorageGCSCredential
WITH
    IDENTITY = 'gcsstorage',
    SECRET = 'HsSBSY9p6x0CpS5n8fuEeg4VLLy+QN8YN5c+NdLUsju2X444qWSQya4CqB0uMqjJUjmy/Z9lFA2oCq8035IEAQ=='
;


-- C: Create an external data source
-- TYPE: HADOOP - PolyBase uses Hadoop APIs to access data in Azure blob storage.
-- LOCATION: Provide Azure storage account name and blob container name.
-- CREDENTIAL: Provide the credential created in the previous step.

CREATE EXTERNAL DATA SOURCE BlobStorageGCS
WITH (
    TYPE = HADOOP,
    LOCATION = 'wasbs://materialattachedrate@gcsstorage.blob.core.windows.net',
    CREDENTIAL = BlobStorageGCSCredential
);


CREATE EXTERNAL FILE FORMAT CSVFileFormatGCS 
WITH 
(   FORMAT_TYPE = DELIMITEDTEXT
,    FORMAT_OPTIONS    (   FIELD_TERMINATOR = '|'
                    ,    STRING_DELIMITER = ''
                    ,    DATE_FORMAT         = 'yyyy-MM-dd HH:mm:ss'
                    ,    USE_TYPE_DEFAULT = FALSE 
                    )
);

CREATE EXTERNAL FILE FORMAT CSVFileFormatGCS_NoDateformat 
WITH 
(   FORMAT_TYPE = DELIMITEDTEXT
,    FORMAT_OPTIONS    (   FIELD_TERMINATOR = '|'
                    ,    STRING_DELIMITER = ''
                    ,    USE_TYPE_DEFAULT = FALSE 
                    )
);

CREATE EXTERNAL FILE FORMAT ORCFileFormatGCS  
WITH (  
    FORMAT_TYPE = ORC, 
    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.DefaultCodec'
);  

CREATE SCHEMA [ext_gcs];

========================[Calender]===========================

CREATE EXTERNAL TABLE [ext_gcs].[Calender](
	[Day] [datetime] NULL,
	[Weekday] [int] NULL,
	[Sun] [datetime] NULL,
	[Sat] [datetime] NULL,
	[week_year] [int] NULL,
	[week_month] [int] NULL,
	[week_Quarter] [int] NULL,
	[First_Sunday] [datetime] NULL,
	[week] [int] NULL,
	[Time_no] [int] NULL,
	[Day_Year] [int] NULL,
	[Day_Month] [int] NULL,
	[Day_Quarter] [int] NULL
)WITH
(
    LOCATION='CALENDER/CALENDER_20180207.csv',
	DATA_SOURCE = BlobStorageGCS,
	FILE_FORMAT = CSVFileFormatGCS,
	REJECT_TYPE = VALUE,
	REJECT_VALUE = 1
)
;

--Export to Blob

CREATE EXTERNAL TABLE [ext_gcs].[Exported_Calender]
WITH 
(
    LOCATION='\ExportData_20180208\Calender\',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS
)
AS
SELECT  * 
FROM    [ext_gcs].[Calender]
;


========================[VW_ASP2Region]===========================

CREATE EXTERNAL TABLE [ext_gcs].[VW_ASP2Region](
	[ASP] [varchar](50) NOT NULL,
	[Country] [varchar](50) NULL,
	[Region] [varchar](50) NULL,
	[Flag] [varchar](50) NULL
)WITH
(
    LOCATION='VW_ASP2Region/VW_ASP2Region_20180207.csv',
	DATA_SOURCE = BlobStorageGCS,
	FILE_FORMAT = CSVFileFormatGCS,
	REJECT_TYPE = VALUE,
	REJECT_VALUE = 1
)
;
--Export to Blob

CREATE EXTERNAL TABLE [ext_gcs].[Exported_VW_ASP2Region]
WITH 
(
    LOCATION='\ExportData_20180208\VW_ASP2Region\',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS
)
AS
SELECT  * 
FROM    [ext_gcs].[VW_ASP2Region]
;
========================[KPI_MAR_REPAIR_UNIT]===========================

CREATE EXTERNAL TABLE [ext_gcs].[KPI_MAR_REPAIR_UNIT](
	[BAAN_MODEL] varchar(30),
    [ITEM_NO] varchar(16),
    [COMPANY] varchar(100),
    [SFC_DISTRIBUTOR_NO] nvarchar(100),
    [WARRANTY] varchar(20),
    [END_DATE] datetime,
    [MAX_REPAIR_LEVEL] varchar(50),
    [Dtl_type] varchar(10),
    [QTY] int,
    [CREATEDATE] datetime,
    [END_YearNo] int,
    [END_QuarterNo] int,
    [END_MonthNo] int,
    [END_WeekNo] int
)WITH (
    LOCATION='KPI_MAR_REPAIR_UNIT/KPI_MAR_REPAIR_UNIT_20180207.csv',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS_NoDateformat,
	REJECT_TYPE = VALUE,
	REJECT_VALUE = 1
)
;
	
--Export to Blob

CREATE EXTERNAL TABLE [ext_gcs].[Exported_KPI_MAR_REPAIR_UNIT]
WITH 
(
    LOCATION='\ExportData_20180208\KPI_MAR_REPAIR_UNIT\',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS_NoDateformat
)
AS
SELECT  * 
FROM    [ext_gcs].[KPI_MAR_REPAIR_UNIT]
;

==================================ISSUE=====================================
--DROP EXTERNAL TABLE [ext_gcs].[Exported_KPI_MAR_REPAIR_UNIT];
	
--Export to Blob

CREATE EXTERNAL TABLE [ext_gcs].[Exported_KPI_MAR_REPAIR_UNIT]
WITH 
(
    LOCATION='\ExportData_20180208\KPI_MAR_REPAIR_UNIT\',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS_NoDateformat
)
AS
SELECT  * 
FROM    [dbo].[KPI_MAR_REPAIR_UNIT]
;

--DROP EXTERNAL TABLE [ext_gcs].[Imported_KPI_MAR_REPAIR_UNIT];

--Import From Blob

CREATE EXTERNAL TABLE [ext_gcs].[Imported_KPI_MAR_REPAIR_UNIT](
	[BAAN_MODEL] varchar(30),
    [ITEM_NO] varchar(16),
    [COMPANY] varchar(100),
    [SFC_DISTRIBUTOR_NO] nvarchar(100),
    [WARRANTY] varchar(20),
    [END_DATE] datetime,
    [MAX_REPAIR_LEVEL] varchar(50),
    [Dtl_type] varchar(10),
    [QTY] int,
    [CREATEDATE] datetime,
    [END_YearNo] int,
    [END_QuarterNo] int,
    [END_MonthNo] int,
    [END_WeekNo] int
)WITH (
    LOCATION='\ExportData_20180208\KPI_MAR_REPAIR_UNIT\',
    DATA_SOURCE = BlobStorageGCS,
    FILE_FORMAT = CSVFileFormatGCS_NoDateformat,
	REJECT_TYPE = VALUE,
	REJECT_VALUE = 1
)
;

SELECT * FROM [ext_gcs].[Imported_KPI_MAR_REPAIR_UNIT];
===============================Source Data==================================
SELECT * FROM [dbo].[KPI_MAR_REPAIR_UNIT] 
WHERE [COMPANY]='MOBIHU' AND [SFC_DISTRIBUTOR_NO]='Hungary' AND [END_DATE]='2004-02-27 00:00:00.000'
;